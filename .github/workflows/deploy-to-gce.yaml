name: BUild and Deploy to Google Compute Engine

on:
  push:
    branches: ["master", "#177-Deploy-backend-automatic"]

env:
  PROJECT_ID: ${{ secrets.GCE_PROJECT }}
  GCE_INSTANCE: cultucat-back
  GCE_INSTANCE_ZONE: us-central1-a

jobs:
  ssh:
      runs-on: 'ubuntu-latest'
      permissions:
        contents: 'read'
        id-token: 'write'

      steps:
        - name: 'Checkout'
          uses: 'actions/checkout@v3'

        - id: 'auth'
          name: 'Authenticate to Google Cloud'
          uses: 'google-github-actions/auth@v2'
          with:
            credentials_json: '${{ secrets.GCE_SA_KEY }}'

        - name: 'SSH to GCP instance'
          id: 'compute-ssh'
          uses: 'google-github-actions/ssh-compute@v1'
          with:
            instance_name: '${{ env.GCE_INSTANCE }}'
            zone: '${{ env.GCE_INSTANCE_ZONE }}'
            ssh_private_key: '${{ secrets.GCP_SSH_PRIVATE_KEY }}'
            script: '${{ github.workspace }}/script-deploy/script.sh'

        - name: 'Show Output'
          run: |-
            echo '${{ steps.ssh.outputs.stdout }}'
            echo '${{ steps.ssh.outputs.stderr }}'